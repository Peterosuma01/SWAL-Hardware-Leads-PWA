<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Steelwool Africa LTD - Lead Generation Follow-up</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh; padding:20px; display:flex; justify-content:center; align-items:center; }
    .container { background:white; border-radius:12px; box-shadow:0 20px 60px rgba(0,0,0,0.3); max-width:760px; width:100%; padding:28px; }
    .header { text-align:center; margin-bottom:18px; padding-bottom:12px; border-bottom:3px solid #667eea; }
    h1 { color:#333; font-size:22px; margin-bottom:4px; }
    .subtitle { color:#666; font-size:14px; }
    .form-group { margin-bottom:14px; }
    label { display:block; margin-bottom:8px; color:#333; font-weight:600; font-size:13px; }
    input[type="text"], input[type="password"], input[type="email"], select { width:100%; padding:10px 12px; border:2px solid #e1e8ed; border-radius:8px; font-size:13px; transition:all 0.3s ease; background:white; }
    select { cursor:pointer; appearance:none; padding-right:40px; }
    .section-title { color:#667eea; font-size:16px; font-weight:700; margin-top:18px; margin-bottom:10px; padding-bottom:6px; border-bottom:2px solid #f0f0f0; }
    .btn { width:100%; padding:12px; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; border:none; border-radius:8px; font-size:15px; font-weight:600; cursor:pointer; transition:all 0.3s ease; margin-top:8px; }
    .btn.small { width:48%; padding:10px; font-size:13px; }
    .btn-row { display:flex; gap:8px; }
    .message { padding:12px; border-radius:8px; margin-top:14px; display:none; font-size:13px; }
    .message.success { background:#d4edda; color:#155724; border:1px solid #c3e6cb; }
    .message.error { background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; }
    .message.show { display:block; animation: slideIn 0.3s ease; }
    .loading { display:none; text-align:center; color:#667eea; font-size:13px; margin-top:8px; }
    .loading.show { display:block; }
    @keyframes slideIn { from { opacity:0; transform:translateY(-10px);} to { opacity:1; transform:translateY(0);} }
    .meta { font-size:12px; color:#666; margin-top:6px; }

    /* table */
    .details-table { width:100%; border-collapse:collapse; margin-top:12px; border-radius:8px; overflow:hidden; box-shadow:0 6px 20px rgba(0,0,0,0.06); }
    .details-table th, .details-table td { padding:10px 12px; border-bottom:1px solid #f0f0f0; text-align:left; font-size:13px; }
    .details-table th { background:#fafafa; font-weight:700; color:#333; }
    .small-muted { font-size:12px; color:#666; margin-top:6px; }
    .hidden { display:none; }
    .field-inline { display:flex; gap:8px; align-items:center; }
    .field-inline > * { flex:1; }
    
    /* Leads list table */
    .leads-list-section { margin-top:20px; }
    .leads-table { width:100%; border-collapse:collapse; margin-top:12px; font-size:12px; max-height:400px; overflow-y:auto; display:block; }
    .leads-table thead { position:sticky; top:0; background:#fafafa; z-index:1; }
    .leads-table th, .leads-table td { padding:8px; border:1px solid #e1e8ed; text-align:left; }
    .leads-table th { font-weight:700; color:#333; }
    .leads-table tbody { display:block; max-height:300px; overflow-y:auto; }
    .leads-table thead, .leads-table tbody tr { display:table; width:100%; table-layout:fixed; }
    .btn-list { background: linear-gradient(135deg,#3b82f6 0%,#2563eb 100%); margin-top:12px; }
    
    @media (max-width:640px) {
      .btn-row { flex-direction:column; }
      .btn.small { width:100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Steelwool Africa LTD</h1>
      <p class="subtitle">Lead Generation Follow-up</p>
      <p id="loggedInAs" class="meta"></p>
    </div>

    <form id="leadForm">
      <div class="form-group">
        <label for="roleSelect">Select Role *</label>
        <select id="roleSelect" required>
          <option value="">-- Select Role --</option>
          <option value="Supervisor">Supervisor</option>
          <option value="SalesRep">Sales Representative</option>
        </select>
        <div class="meta">Choose <strong>Supervisor</strong> to edit Qualification and Approve/Decline (password required). Choose <strong>Sales Representative</strong> to edit Presentation (email, password, and approval required).</div>
      </div>

      <!-- Sales Rep Authentication (shown only for SalesRep role) -->
      <div id="salesRepAuthSection" class="hidden">
        <div class="form-group">
          <label for="salesRepEmailAuth">Sales Rep Email (from Column B) *</label>
          <input type="email" id="salesRepEmailAuth" placeholder="salesrep@example.com" required>
          <div class="small-muted">Enter your email address as stored in the sheet (Column B).</div>
        </div>
        <div class="form-group">
          <label for="salesRepPasswordAuth">Sales Rep Password *</label>
          <input type="password" id="salesRepPasswordAuth" placeholder="Enter your password" required>
        </div>
      </div>

      <!-- Buttons for viewing leads lists -->
      <div id="viewLeadsButtons" class="hidden">
        <button type="button" id="viewGeneratedLeadsBtn" class="btn btn-list hidden">View Generated Leads</button>
        <button type="button" id="viewQualifiedLeadsBtn" class="btn btn-list hidden">View Qualified Leads</button>
      </div>

      <div class="form-group">
        <label for="customerCode">Customer Code *</label>
        <div class="field-inline">
          <input type="text" id="customerCode" name="customerCode" required placeholder="Enter customer code">
          <button type="button" id="loadBtn" class="btn small" style="width:auto;padding:10px 14px;">Load</button>
        </div>
        <div style="margin-top:8px;font-size:12px;color:#666;">Enter a code and click <strong>Load</strong> to fetch existing data.</div>
      </div>

      <!-- Leads list display section -->
      <div id="leadsListSection" class="leads-list-section hidden">
        <div class="section-title" id="leadsListTitle">Leads</div>
        <div style="overflow-x:auto;">
          <table class="leads-table" id="leadsTable">
            <thead>
              <tr>
                <th>Region</th>
                <th>Area</th>
                <th>Location</th>
                <th>Store Name</th>
                <th>Contact Person</th>
                <th>Mobile Number</th>
                <th>Outlet Category</th>
                <th>Brands Stocked</th>
                <th>Purchase Frequency</th>
                <th>Main Supplier</th>
                <th>Distributor Type</th>
                <th>Weldplus Awareness</th>
                <th>Additional Feedback</th>
                <th>Customer Code</th>
              </tr>
            </thead>
            <tbody id="leadsTableBody">
            </tbody>
          </table>
        </div>
        <button type="button" id="closeLeadsListBtn" class="btn small" style="background:#9ca3af;margin-top:12px;">Close List</button>
      </div>

      <!-- Details table: shows columns C-H, I-O and P -->
      <div id="detailsSection" class="hidden">
        <div class="section-title">Customer Details</div>
        <div style="overflow-x:auto;">
          <table class="details-table" id="detailsTable">
            <thead>
              <tr>
                <th>Region (C)</th>
                <th>Area (D)</th>
                <th>Location (E)</th>
                <th>Store Name (F)</th>
                <th>Contact Person (G)</th>
                <th>Mobile Number (H)</th>
                <th>Outlet Category (I)</th>
                <th>Brands Stocked (J)</th>
                <th>Purchase Frequency (K)</th>
                <th>Main Supplier (L)</th>
                <th>Distributor Type (M)</th>
                <th>Weldplus Awareness (N)</th>
                <th>Additional Feedback (O)</th>
                <th>Customer Code (P)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td id="d_region"></td>
                <td id="d_area"></td>
                <td id="d_location"></td>
                <td id="d_storeName"></td>
                <td id="d_contactPerson"></td>
                <td id="d_mobileNumber"></td>
                <td id="d_outletCategory"></td>
                <td id="d_brandsStocked"></td>
                <td id="d_purchaseFrequency"></td>
                <td id="d_mainSupplier"></td>
                <td id="d_distributorType"></td>
                <td id="d_weldplusAwareness"></td>
                <td id="d_additionalFeedback"></td>
                <td id="d_customerCode"></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="section-title">Qualification</div>
      <div class="form-group">
        <label for="qualification">Qualification Status *</label>
        <select id="qualification" name="qualification" required>
          <option value="">-- Select Status --</option>
          <option value="YES">YES</option>
          <option value="NO">NO</option>
          <option value="Volume Too Small">Volume Too Small</option>
          <option value="Bad Previous History">Bad Previous History</option>
          <option value="Other">Other</option>
        </select>
      </div>

      <div class="btn-row" style="margin-bottom:14px;">
        <button type="button" id="approveBtn" class="btn small" style="background:linear-gradient(135deg,#22c55e 0%,#16a34a 100%); display:none;">Approve</button>
        <button type="button" id="declineBtn" class="btn small" style="background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%); display:none;">Decline</button>
      </div>

      <div class="section-title">Presentation</div>
      <div class="form-group">
        <label for="presentation">Presentation Status *</label>
        <select id="presentation" name="presentation" required>
          <option value="">-- Select Status --</option>
          <option value="YES">YES</option>
          <option value="Refused to Trade">Refused to Trade</option>
          <option value="Refuse to Provide KYC">Refuse to Provide KYC</option>
          <option value="Other">Other</option>
        </select>
      </div>

      <!-- Sales Rep Email (visible only when Supervisor authenticated) -->
      <div id="salesRepEmailContainer" class="form-group hidden">
        <label for="salesRepEmail">Sales Rep Email (saved to sheet column B)</label>
        <input type="email" id="salesRepEmail" placeholder="salesrep@example.com" />
        <div class="small-muted">Optional: enter the sales rep's email and click Approve / Decline or Submit to save it.</div>
      </div>

      <button type="submit" class="btn" id="submitBtn">Submit</button>

      <div class="loading" id="loading">Processing...</div>
      <div class="message" id="message"></div>
    </form>
  </div>

  <!-- Password modal (hidden by default) -->
  <div id="passwordModal" style="display:none;">
    <div class="modal-overlay" id="modalOverlay" style="position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;justify-content:center;align-items:center;z-index:1000;">
      <div class="modal" role="dialog" aria-modal="true" style="background:white;padding:18px;border-radius:8px;width:320px;box-shadow:0 10px 30px rgba(0,0,0,0.3);">
        <h3 style="margin-bottom:10px;font-size:16px;color:#333;">Supervisor Password</h3>
        <div class="row" style="margin-bottom:10px;">
          <input type="password" id="supervisorPasswordInput" placeholder="Enter supervisor password" style="width:100%;padding:10px;border:1px solid #e1e8ed;border-radius:6px;">
        </div>
        <div class="actions" style="display:flex;gap:8px;justify-content:flex-end;">
          <button id="cancelPasswordBtn" class="btn small" style="background:#9ca3af;color:#fff;">Cancel</button>
          <button id="submitPasswordBtn" class="btn small">Submit</button>
        </div>
        <p id="passwordHint" style="font-size:12px;color:#666;margin-top:8px;display:none;"></p>
      </div>
    </div>
  </div>

  <script>
    // Elements
    const roleSelect = document.getElementById('roleSelect');
    const loadBtn = document.getElementById('loadBtn');
    const customerCodeInput = document.getElementById('customerCode');
    const qualificationSelect = document.getElementById('qualification');
    const presentationSelect = document.getElementById('presentation');
    const approveBtn = document.getElementById('approveBtn');
    const declineBtn = document.getElementById('declineBtn');
    const submitBtn = document.getElementById('submitBtn');
    const loading = document.getElementById('loading');
    const message = document.getElementById('message');
    const loggedInAs = document.getElementById('loggedInAs');

    const detailsSection = document.getElementById('detailsSection');
    const d_region = document.getElementById('d_region');
    const d_area = document.getElementById('d_area');
    const d_location = document.getElementById('d_location');
    const d_storeName = document.getElementById('d_storeName');
    const d_contactPerson = document.getElementById('d_contactPerson');
    const d_mobileNumber = document.getElementById('d_mobileNumber');
    const d_outletCategory = document.getElementById('d_outletCategory');
    const d_brandsStocked = document.getElementById('d_brandsStocked');
    const d_purchaseFrequency = document.getElementById('d_purchaseFrequency');
    const d_mainSupplier = document.getElementById('d_mainSupplier');
    const d_distributorType = document.getElementById('d_distributorType');
    const d_weldplusAwareness = document.getElementById('d_weldplusAwareness');
    const d_additionalFeedback = document.getElementById('d_additionalFeedback');
    const d_customerCode = document.getElementById('d_customerCode');

    const salesRepEmailContainer = document.getElementById('salesRepEmailContainer');
    const salesRepEmailInput = document.getElementById('salesRepEmail');

    const salesRepAuthSection = document.getElementById('salesRepAuthSection');
    const salesRepEmailAuth = document.getElementById('salesRepEmailAuth');
    const salesRepPasswordAuth = document.getElementById('salesRepPasswordAuth');

    const passwordModal = document.getElementById('passwordModal');
    const modalOverlay = document.getElementById('modalOverlay');
    const supervisorPasswordInput = document.getElementById('supervisorPasswordInput');
    const submitPasswordBtn = document.getElementById('submitPasswordBtn');
    const cancelPasswordBtn = document.getElementById('cancelPasswordBtn');
    const passwordHint = document.getElementById('passwordHint');

    const viewLeadsButtons = document.getElementById('viewLeadsButtons');
    const viewGeneratedLeadsBtn = document.getElementById('viewGeneratedLeadsBtn');
    const viewQualifiedLeadsBtn = document.getElementById('viewQualifiedLeadsBtn');
    const leadsListSection = document.getElementById('leadsListSection');
    const leadsListTitle = document.getElementById('leadsListTitle');
    const leadsTableBody = document.getElementById('leadsTableBody');
    const closeLeadsListBtn = document.getElementById('closeLeadsListBtn');

    let currentLoadedLead = null;
    let isSupervisorAuthenticated = false;
    let supervisorPasswordCached = '';

    // Display signed-in email for info
    function init() {
      google.script.run.withSuccessHandler(function(res) {
        if (res && res.success && res.email) {
          loggedInAs.textContent = 'Signed in as: ' + res.email;
        } else {
          loggedInAs.textContent = '';
        }
      }).withFailureHandler(function() {
        loggedInAs.textContent = '';
      }).getUserEmail();
    }
    init();

    // Utility: show message
    function showMessage(text, type) {
      message.className = 'message ' + (type === 'error' ? 'error show' : 'success show');
      message.textContent = text;
      setTimeout(() => message.classList.remove('show'), 6000);
    }

    // View Generated Leads (Supervisor only)
    viewGeneratedLeadsBtn.addEventListener('click', function() {
      loading.classList.add('show');
      
      google.script.run.withSuccessHandler(function(res) {
        loading.classList.remove('show');
        
        if (!res || !res.success) {
          showMessage(res && res.message ? res.message : 'Unable to load leads', 'error');
          return;
        }
        
        displayLeadsList(res.data, 'Generated Leads');
      }).withFailureHandler(function(err) {
        loading.classList.remove('show');
        showMessage('Error loading leads: ' + err.message, 'error');
      }).getAllGeneratedLeads();
    });

    // View Qualified Leads (Sales Rep only)
    viewQualifiedLeadsBtn.addEventListener('click', function() {
      const salesRepEmail = salesRepEmailAuth.value.trim();
      const salesRepPassword = salesRepPasswordAuth.value.trim();
      
      if (!salesRepEmail || !salesRepPassword) {
        showMessage('Please enter your email and password first.', 'error');
        return;
      }
      
      loading.classList.add('show');
      
      google.script.run.withSuccessHandler(function(res) {
        loading.classList.remove('show');
        
        if (!res || !res.success) {
          showMessage(res && res.message ? res.message : 'Unable to load leads', 'error');
          return;
        }
        
        if (res.data.length === 0) {
          showMessage('No qualified leads found for your account.', 'error');
          return;
        }
        
        displayLeadsList(res.data, 'Qualified Leads (Approved)');
      }).withFailureHandler(function(err) {
        loading.classList.remove('show');
        showMessage('Error loading leads: ' + err.message, 'error');
      }).getQualifiedLeadsBySalesRep(salesRepEmail, salesRepPassword);
    });

    // Display leads list in table
    function displayLeadsList(leads, title) {
      leadsListTitle.textContent = title;
      leadsTableBody.innerHTML = '';
      
      leads.forEach(function(lead) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${lead.region || ''}</td>
          <td>${lead.area || ''}</td>
          <td>${lead.location || ''}</td>
          <td>${lead.storeName || ''}</td>
          <td>${lead.contactPerson || ''}</td>
          <td>${lead.mobileNumber || ''}</td>
          <td>${lead.outletCategory || ''}</td>
          <td>${lead.brandsStocked || ''}</td>
          <td>${lead.purchaseFrequency || ''}</td>
          <td>${lead.mainSupplier || ''}</td>
          <td>${lead.distributorType || ''}</td>
          <td>${lead.weldplusAwareness || ''}</td>
          <td>${lead.additionalFeedback || ''}</td>
          <td>${lead.customerCode || ''}</td>
        `;
        leadsTableBody.appendChild(row);
      });
      
      leadsListSection.classList.remove('hidden');
      detailsSection.classList.add('hidden');
    }

    // Close leads list
    closeLeadsListBtn.addEventListener('click', function() {
      leadsListSection.classList.add('hidden');
    });

    // Load lead details
    loadBtn.addEventListener('click', function() {
      const code = customerCodeInput.value.trim();
      const role = roleSelect.value;

      if (!role) { 
        showMessage('Please select a role first.', 'error'); 
        return; 
      }

      if (!code) { 
        showMessage('Enter customer code to load.', 'error'); 
        return; 
      }

      let salesRepEmail = '';
      let salesRepPassword = '';
      
      if (role === 'SalesRep') {
        salesRepEmail = salesRepEmailAuth.value.trim();
        salesRepPassword = salesRepPasswordAuth.value.trim();
        
        if (!salesRepEmail) {
          showMessage('Please enter your Sales Rep email address.', 'error');
          return;
        }
        
        if (!salesRepPassword) {
          showMessage('Please enter your Sales Rep password.', 'error');
          return;
        }
      }

      loading.classList.add('show');
      google.script.run.withSuccessHandler(function(res) {
        loading.classList.remove('show');
        if (!res || !res.success) {
          showMessage(res && res.message ? res.message : 'Unable to load lead', 'error');
          return;
        }
        currentLoadedLead = res.data;
        qualificationSelect.value = currentLoadedLead.qualification || '';
        presentationSelect.value = currentLoadedLead.presentation || '';
        salesRepEmailInput.value = currentLoadedLead.salesRepEmail || '';

        d_region.textContent = currentLoadedLead.region || '';
        d_area.textContent = currentLoadedLead.area || '';
        d_location.textContent = currentLoadedLead.location || '';
        d_storeName.textContent = currentLoadedLead.storeName || '';
        d_contactPerson.textContent = currentLoadedLead.contactPerson || '';
        d_mobileNumber.textContent = currentLoadedLead.mobileNumber || '';
        d_outletCategory.textContent = currentLoadedLead.outletCategory || '';
        d_brandsStocked.textContent = currentLoadedLead.brandsStocked || '';
        d_purchaseFrequency.textContent = currentLoadedLead.purchaseFrequency || '';
        d_mainSupplier.textContent = currentLoadedLead.mainSupplier || '';
        d_distributorType.textContent = currentLoadedLead.distributorType || '';
        d_weldplusAwareness.textContent = currentLoadedLead.weldplusAwareness || '';
        d_additionalFeedback.textContent = currentLoadedLead.additionalFeedback || '';
        d_customerCode.textContent = currentLoadedLead.customerCode || '';

        detailsSection.classList.remove('hidden');
        leadsListSection.classList.add('hidden');

        if (role === 'Supervisor') {
          isSupervisorAuthenticated = false;
          supervisorPasswordCached = '';
          supervisorPasswordInput.value = '';
          passwordHint.style.display = 'none';
        }
        
        updateUiForRoleAndStatus();
        showMessage('Lead loaded successfully (row ' + currentLoadedLead.row + ')', 'success');
      }).withFailureHandler(function(err) {
        loading.classList.remove('show');
        showMessage('Error loading lead: ' + err.message, 'error');
      }).getLeadStatus(code, role, salesRepEmail, salesRepPassword);
    });

    // Update UI based on selected role and approval status
    function updateUiForRoleAndStatus() {
      const role = roleSelect.value;
      const approval = (currentLoadedLead && currentLoadedLead.approval) ? currentLoadedLead.approval.toString() : '';

      qualificationSelect.disabled = true;
      presentationSelect.disabled = true;
      approveBtn.style.display = 'none';
      declineBtn.style.display = 'none';
      salesRepEmailContainer.classList.add('hidden');
      salesRepAuthSection.classList.add('hidden');
      viewLeadsButtons.classList.add('hidden');
      viewGeneratedLeadsBtn.classList.add('hidden');
      viewQualifiedLeadsBtn.classList.add('hidden');

      if (!role) {
        return;
      }

      if (role === 'Supervisor') {
        if (isSupervisorAuthenticated) {
          qualificationSelect.disabled = false;
          approveBtn.style.display = 'inline-block';
          declineBtn.style.display = 'inline-block';
          presentationSelect.disabled = true;
          salesRepEmailContainer.classList.remove('hidden');
          viewLeadsButtons.classList.remove('hidden');
          viewGeneratedLeadsBtn.classList.remove('hidden');
        } else {
          showPasswordModal();
        }
      } else if (role === 'SalesRep') {
        salesRepAuthSection.classList.remove('hidden');
        
        qualificationSelect.disabled = true;
        approveBtn.style.display = 'none';
        declineBtn.style.display = 'none';
        salesRepEmailContainer.classList.add('hidden');
        
        if (approval === 'Approved') {
          presentationSelect.disabled = false;
        } else {
          presentationSelect.disabled = true;
        }

        // Show qualified leads button after authentication
        if (salesRepEmailAuth.value.trim() && salesRepPasswordAuth.value.trim()) {
          viewLeadsButtons.classList.remove('hidden');
          viewQualifiedLeadsBtn.classList.remove('hidden');
        }

        isSupervisorAuthenticated = false;
        supervisorPasswordCached = '';
        supervisorPasswordInput.value = '';
        passwordHint.style.display = 'none';
      }
    }

    // When role changes
    roleSelect.addEventListener('change', function() {
      currentLoadedLead = null;
      detailsSection.classList.add('hidden');
      leadsListSection.classList.add('hidden');
      qualificationSelect.value = '';
      presentationSelect.value = '';
      
      updateUiForRoleAndStatus();
    });

    // Show password modal
    function showPasswordModal() {
      passwordModal.style.display = 'block';
      modalOverlay.style.display = 'flex';
      supervisorPasswordInput.value = '';
      supervisorPasswordInput.focus();
    }

    // Hide password modal
    function hidePasswordModal() {
      passwordModal.style.display = 'none';
      modalOverlay.style.display = 'none';
      supervisorPasswordInput.value = '';
    }

    // Cancel password entry
    cancelPasswordBtn.addEventListener('click', function() {
      hidePasswordModal();
      roleSelect.value = '';
      updateUiForRoleAndStatus();
    });

    // Submit password for validation
    submitPasswordBtn.addEventListener('click', function() {
      const pw = supervisorPasswordInput.value.trim();

      if (!pw) {
        passwordHint.textContent = 'Please enter the password.';
        passwordHint.style.display = 'block';
        return;
      }

      loading.classList.add('show');

      google.script.run
        .withSuccessHandler(function(res) {
          loading.classList.remove('show');

          if (!res || !res.success) {
            passwordHint.textContent = (res && res.message) ? res.message : 'Invalid supervisor password.';
            passwordHint.style.display = 'block';
            return;
          }

          isSupervisorAuthenticated = true;
          supervisorPasswordCached = pw;

          hidePasswordModal();
          updateUiForRoleAndStatus();
          showMessage('Supervisor authenticated.', 'success');
        })
        .withFailureHandler(function(err) {
          loading.classList.remove('show');
          passwordHint.textContent = 'Server error: ' + err.message;
          passwordHint.style.display = 'block';
        })
        .validateSupervisorPassword(pw);
    });

    // Approve handler
    approveBtn.addEventListener('click', function() {
      if (!currentLoadedLead) { showMessage('Load a lead first', 'error'); return; }
      if (roleSelect.value !== 'Supervisor') { showMessage('Select Supervisor role to approve.', 'error'); return; }
      if (!isSupervisorAuthenticated || !supervisorPasswordCached) { showMessage('Supervisor not authenticated. Please enter password.', 'error'); showPasswordModal(); return; }

      const code = customerCodeInput.value.trim();
      const qualificationValue = qualificationSelect.value;
      const salesEmail = salesRepEmailInput.value.trim();

      if (!qualificationValue) { showMessage('Please select a qualification status before approving.', 'error'); return; }

      submitBtn.disabled = true;
      loading.classList.add('show');

      google.script.run.withSuccessHandler(function(res) {
        loading.classList.remove('show');
        submitBtn.disabled = false;
        if (res && res.success) {
          google.script.run.withSuccessHandler(function(r2) {
            if (r2 && r2.success) {
              currentLoadedLead = r2.data;
              qualificationSelect.value = currentLoadedLead.qualification || '';
              presentationSelect.value = currentLoadedLead.presentation || '';
              salesRepEmailInput.value = currentLoadedLead.salesRepEmail || '';
              updateUiForRoleAndStatus();
            }
          }).getLeadStatus(code, 'Supervisor', '', '');
          showMessage('Qualification approved and updated.', 'success');
        } else {
          showMessage(res && res.message ? res.message : 'Error approving', 'error');
        }
      }).withFailureHandler(function(err) {
        loading.classList.remove('show');
        submitBtn.disabled = false;
        showMessage('Error: ' + err.message, 'error');
      }).updateQualificationBySupervisor(code, qualificationValue, 'Approved', salesEmail, supervisorPasswordCached);
    });

    // Decline handler
    declineBtn.addEventListener('click', function() {
      if (!currentLoadedLead) { showMessage('Load a lead first', 'error'); return; }
      if (roleSelect.value !== 'Supervisor') { showMessage('Select Supervisor role to decline.', 'error'); return; }
      if (!isSupervisorAuthenticated || !supervisorPasswordCached) { showMessage('Supervisor not authenticated. Please enter password.', 'error'); showPasswordModal(); return; }

      const code = customerCodeInput.value.trim();
      const qualificationValue = qualificationSelect.value;
      const salesEmail = salesRepEmailInput.value.trim();

      if (!qualificationValue) { showMessage('Please select a qualification status before declining.', 'error'); return; }

      submitBtn.disabled = true;
      loading.classList.add('show');

      google.script.run.withSuccessHandler(function(res) {
        loading.classList.remove('show');
        submitBtn.disabled = false;
        if (res && res.success) {
          google.script.run.withSuccessHandler(function(r2) {
            if (r2 && r2.success) {
              currentLoadedLead = r2.data;
              qualificationSelect.value = currentLoadedLead.qualification || '';
              presentationSelect.value = currentLoadedLead.presentation || '';
              salesRepEmailInput.value = currentLoadedLead.salesRepEmail || '';
              updateUiForRoleAndStatus();
            }
          }).getLeadStatus(code, 'Supervisor', '', '');
          showMessage('Qualification declined. Presentation locked.', 'success');
        } else {
          showMessage(res && res.message ? res.message : 'Error declining', 'error');
        }
      }).withFailureHandler(function(err) {
        loading.classList.remove('show');
        submitBtn.disabled = false;
        showMessage('Error: ' + err.message, 'error');
      }).updateQualificationBySupervisor(code, qualificationValue, 'Declined', salesEmail, supervisorPasswordCached);
    });

    // Form submit
    document.getElementById('leadForm').addEventListener('submit', function(e) {
      e.preventDefault();

      const code = customerCodeInput.value.trim();
      if (!code) { showMessage('Enter a customer code and Load it first.', 'error'); return; }
      if (!currentLoadedLead) { showMessage('Load lead first.', 'error'); return; }

      const role = roleSelect.value;

      if (role === 'Supervisor') {
        if (!isSupervisorAuthenticated || !supervisorPasswordCached) { showMessage('Supervisor not authenticated. Please enter password.', 'error'); showPasswordModal(); return; }

        const qual = qualificationSelect.value;
        const salesEmail = salesRepEmailInput.value.trim();

        submitBtn.disabled = true;
        loading.classList.add('show');

        google.script.run.withSuccessHandler(function(res) {
          loading.classList.remove('show');
          submitBtn.disabled = false;
          if (res && res.success) {
            google.script.run.withSuccessHandler(function(r2) {
              if (r2 && r2.success) {
                currentLoadedLead = r2.data;
                qualificationSelect.value = currentLoadedLead.qualification || '';
                presentationSelect.value = currentLoadedLead.presentation || '';
                salesRepEmailInput.value = currentLoadedLead.salesRepEmail || '';
                updateUiForRoleAndStatus();
              }
            }).getLeadStatus(code, 'Supervisor', '', '');
            showMessage('Qualification updated by Supervisor.', 'success');
          } else {
            showMessage(res && res.message ? res.message : 'Error updating qualification', 'error');
          }
        }).withFailureHandler(function(err) {
          loading.classList.remove('show');
          submitBtn.disabled = false;
          showMessage('Error: ' + err.message, 'error');
        }).updateQualificationBySupervisor(code, qual, '', salesEmail, supervisorPasswordCached);
        return;
      }

      if (role === 'SalesRep') {
        const pres = presentationSelect.value;
        if (!pres) { showMessage('Select a presentation status before submitting.', 'error'); return; }

        const salesRepEmail = salesRepEmailAuth.value.trim();
        const salesRepPassword = salesRepPasswordAuth.value.trim();

        if (!salesRepEmail || !salesRepPassword) {
          showMessage('Sales Rep email and password are required.', 'error');
          return;
        }

        submitBtn.disabled = true;
        loading.classList.add('show');

        google.script.run.withSuccessHandler(function(res) {
          loading.classList.remove('show');
          submitBtn.disabled = false;
          if (res && res.success) {
            google.script.run.withSuccessHandler(function(r2) {
              if (r2 && r2.success) {
                currentLoadedLead = r2.data;
                qualificationSelect.value = currentLoadedLead.qualification || '';
                presentationSelect.value = currentLoadedLead.presentation || '';
                salesRepEmailInput.value = currentLoadedLead.salesRepEmail || '';
                updateUiForRoleAndStatus();
              }
            }).getLeadStatus(code, 'SalesRep', salesRepEmail, salesRepPassword);
            showMessage('Presentation updated successfully.', 'success');
          } else {
            showMessage(res && res.message ? res.message : 'Error updating presentation', 'error');
          }
        }).withFailureHandler(function(err) {
          loading.classList.remove('show');
          submitBtn.disabled = false;
          showMessage('Error: ' + err.message, 'error');
        }).updatePresentationBySalesRep(code, pres, salesRepEmail, salesRepPassword);

        return;
      }

      showMessage('Please select a role (Supervisor or Sales Representative) before submitting.', 'error');
    });
  </script>
</body>
</html>
